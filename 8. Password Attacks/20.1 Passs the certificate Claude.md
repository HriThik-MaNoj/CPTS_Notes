# Complete Learning Guide: Certificates, Kerberos & AD Attacks

Let me build your understanding **layer by layer** â€” like a building, each floor depends on the one below it.

---

# ğŸ—ï¸ FLOOR 1: The Basics of Authentication

## What is Authentication?

Authentication is simply answering the question: **"Are you really who you claim to be?"**

In real life, you prove identity with:

- A password (something you **know**)
- A key card (something you **have**)
- A fingerprint (something you **are**)

In Windows Active Directory, computers and users need to prove their identity constantly â€” every time they access a file share, a database, a website, anything. The protocol that handles this is called **Kerberos**.

---

## What is Active Directory (AD)?

Think of Active Directory as the **"phonebook + security guard + HR department"** of a company's network.

```
COMPANY NETWORK
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚  Active Directory                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Domain Controller (DC)                 â”‚  â”‚
â”‚  â”‚  - Knows every user account             â”‚  â”‚
â”‚  â”‚  - Knows every computer account         â”‚  â”‚
â”‚  â”‚  - Decides who can access what          â”‚  â”‚
â”‚  â”‚  - Issues Kerberos tickets              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                               â”‚
â”‚   Users: wwhite, jpinkman, Administrator      â”‚
â”‚   Computers: DC01$, WORKSTATION01$            â”‚
â”‚   Domain Name: INLANEFREIGHT.LOCAL            â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

Every machine and user in a company is part of a **domain** (like `INLANEFREIGHT.LOCAL`). The Domain Controller (DC) is the **king** â€” it controls everything. If you control the DC, you control the entire company network.

Notice something important: **computers have accounts too** â€” they end with `$` (like `DC01$`). This matters a lot later.

---

# ğŸ—ï¸ FLOOR 2: How Kerberos Works

## The Theme Park Analogy

Kerberos is easiest to understand with an analogy. Imagine a **theme park**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    KERBEROS THEME PARK                      â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   YOU    â”‚    â”‚  TICKET BOOTHâ”‚    â”‚   PARK RIDES     â”‚  â”‚
â”‚  â”‚  (User)  â”‚    â”‚    (KDC)     â”‚    â”‚  (Services)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  Step 1: You show ID at ticket booth â†’ get MASTER PASS     â”‚
â”‚  Step 2: Show master pass â†’ get RIDE TICKET for each ride  â”‚
â”‚  Step 3: Show ride ticket at ride entrance â†’ get access    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

In Kerberos language:

- **You** = Client (user or computer)
- **Ticket Booth** = KDC (Key Distribution Center) â€” runs on the Domain Controller
- **Master Pass** = TGT (Ticket Granting Ticket)
- **Ride Ticket** = Service Ticket (TGS)
- **Park Rides** = Services (file shares, web apps, databases, etc.)

## The Actual Kerberos Flow

```
STEP 1: AS-REQ (Authentication Service Request)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
User â†’ KDC: "Hi, I'm jpinkman. I know my password. 
             Please give me a TGT."
             
             (The proof is encrypted with the user's 
              password hash â€” no password sent in clear)

STEP 2: AS-REP (Authentication Service Reply)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
KDC â†’ User: "Here's your TGT, valid for 10 hours.
             It's encrypted â€” only I can read it."

STEP 3: TGS-REQ (Ticket Granting Service Request)  
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
User â†’ KDC: "I want to access the file server.
             Here's my TGT as proof of who I am."

STEP 4: TGS-REP
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
KDC â†’ User: "OK, here's a service ticket for the 
             file server."

STEP 5: AP-REQ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”
User â†’ File Server: "Here's my service ticket."
File Server: "Valid! Come in."
```

## Why Does This Matter for Hacking?

If an attacker **steals your TGT**, they can use it to impersonate you to get service tickets â€” without ever knowing your password. This is called **Pass-the-Ticket (PtT)**.

If an attacker gets a TGT for the **Domain Controller's machine account (DC01$)**, they can do a **DCSync attack** â€” pretending to be a second DC and asking for all password hashes in the entire domain. Game over.

---

# ğŸ—ï¸ FLOOR 3: Normal Password Authentication vs Certificate Authentication

## Normal Kerberos (Password-Based)

```
Normal Flow:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User has password: "Summer2024!"
â†“
Windows converts it to NTLM hash: 
"abc123def456..."
â†“
This hash is used to encrypt/prove 
identity to the KDC
â†“
KDC checks: "Does this hash match what 
I have stored for this user?"
â†“
If yes â†’ TGT issued
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

The hash is essentially "the secret" that proves who you are. If an attacker steals your hash, they can **Pass-the-Hash** to authenticate as you.

## PKINIT (Certificate-Based Kerberos)

PKINIT = **Public Key Cryptography for Initial Authentication**

This is an _extension_ to Kerberos that replaces the password hash with a **certificate and private key**.

```
PKINIT Flow:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
User has: Certificate + Private Key
         (.pfx file contains both)
â†“
Instead of "I know the password hash"
User says: "I have this certificate, and 
I can prove I hold its private key"
â†“
KDC checks: "Is this certificate valid?
Was it signed by our trusted CA?"
â†“
If yes â†’ TGT issued
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**Key insight:** If you have someone's `.pfx` file, you can authenticate AS THEM via PKINIT â€” even without knowing their password.

---

# ğŸ—ï¸ FLOOR 4: Certificates & Public Key Cryptography

## The Padlock Analogy

This is the most important concept to understand clearly:

```
ASYMMETRIC CRYPTOGRAPHY (Public/Private Key):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Imagine a special padlock with two keys:

PRIVATE KEY = The secret key you NEVER share
              "Only I have this"
              Used to: SIGN things, DECRYPT things

PUBLIC KEY  = The key you share with everyone
              "Anyone can have a copy"
              Used to: VERIFY signatures, ENCRYPT things

The magic: What one key locks, only the other can unlock
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## What is an X.509 Certificate?

A certificate is like a **government-issued ID card** that says:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CERTIFICATE                   â”‚
â”‚                                         â”‚
â”‚  Subject:  jpinkman@INLANEFREIGHT.LOCAL â”‚
â”‚  Issuer:   INLANEFREIGHT-CA01-CA        â”‚
â”‚  Valid:    2024-01-01 to 2025-01-01     â”‚
â”‚  Public Key: [long number]              â”‚
â”‚                                         â”‚
â”‚  Signature: [CA digitally signed this] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

The CA (Certificate Authority) has signed this certificate saying "I vouch that this public key belongs to jpinkman." When the KDC sees this, it trusts the CA's signature, so it trusts the certificate.

## What is a .PFX File?

```
.PFX file (PKCS#12 format) contains:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Certificate (the ID card with public key)
  +
  Private Key (the secret key)
  +
  Password protection (optional)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

Having a `.pfx` = having someone's complete identity credential. You can authenticate AS them.

## What is AD CS?

**Active Directory Certificate Services** is Microsoft's Certificate Authority system built into Windows Server.

```
AD CS does:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  âœ¦ Issues certificates to users and computers
  âœ¦ Manages "templates" (blueprints for certificates)
  âœ¦ Has a web interface at /CertSrv for enrollment
  âœ¦ Is the trusted "government" that signs all the IDs
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

When AD CS signs a certificate, the KDC will trust it for PKINIT authentication.

---

# ğŸ—ï¸ FLOOR 5: NTLM & Relay Attacks

## What is NTLM?

NTLM is an older Microsoft authentication protocol (still widely used). It works like this:

```
NTLM Challenge-Response:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Server: "Prove who you are. Here's a random 
         number (challenge): 48291"

Client: "I'll encrypt that number with my 
         password hash: [encrypted result]"

Server: "Let me check that with the DC..."

DC: "Yes, that encryption matches â€” it's really them!"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## What is an NTLM Relay Attack?

Here's where it gets clever. NTLM doesn't verify _who is asking_ â€” it just verifies _the response_.

```
NTLM RELAY ATTACK:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VICTIM (DC01$)          ATTACKER              TARGET (CA01)
      |                     |                       |
      |â”€â”€"I want to auth"â”€â”€>|                       |
      |                     |â”€â”€forwards to targetâ”€â”€>|
      |                     |<â”€â”€"challenge: 48291"â”€â”€|
      |<â”€â”€"challenge: 48291"|                       |
      |â”€â”€"response: xyz"â”€â”€â”€>|                       |
      |                     |â”€â”€forwards responseâ”€â”€â”€>|
      |                     |<â”€â”€"AUTH SUCCESSFUL"â”€â”€â”€|
      |                     |                       |
      ATTACKER authenticated to TARGET 
      using VICTIM's credentials â€” without 
      knowing the password!
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

The attacker is just **in the middle**, passing messages back and forth â€” but the end result is that the target service thinks it authenticated with the victim.

---

# ğŸ—ï¸ FLOOR 6: The msDS-KeyCredentialLink Attribute

## What Is It?

Every user and computer object in Active Directory has many **attributes** â€” fields that store information about them. Examples:

```
jpinkman's AD Object:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sAMAccountName:          jpinkman
  displayName:             Jesse Pinkman  
  mail:                    jpinkman@inlanefreight.local
  memberOf:                Remote Management Users
  unicodePwd:              [password hash - secret]
  msDS-KeyCredentialLink:  [public keys for PKINIT auth]
  ...many more attributes...
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

**msDS-KeyCredentialLink** is the attribute that stores public keys trusted for PKINIT authentication. Think of it as jpinkman's "trusted padlocks" list.

```
msDS-KeyCredentialLink for jpinkman:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Entry 1: [Public key from jpinkman's smart card]
  Entry 2: [Could be empty in most environments]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## The Shadow Credentials Attack

If you have **write permission** to someone's `msDS-KeyCredentialLink`, you can add YOUR OWN public key to their trusted list. Then you can authenticate as them using your private key.

```
SHADOW CREDENTIALS ATTACK:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BEFORE ATTACK:
  jpinkman's msDS-KeyCredentialLink = [empty or jpinkman's key]

AFTER ATTACK (wwhite adds their key):
  jpinkman's msDS-KeyCredentialLink = [jpinkman's key, 
                                       ATTACKER'S public key]
  
NOW:
  Attacker presents their certificate â†’ KDC checks the list
  â†’ Attacker's public key is in jpinkman's trusted list
  â†’ KDC issues TGT for jpinkman to attacker
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

This is called **Shadow Credentials** because you're creating a "shadow" credential for the victim â€” a backdoor into their account that doesn't change their password.

## Why is this Stealthy?

```
Password Reset Scenario:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Defender: "jpinkman was compromised! Reset password!"
  *password reset happens*
  
  Normal attack (hash-based): DEAD â€” hash changed
  Shadow Credentials attack:  STILL WORKS â€” the key 
  in msDS-KeyCredentialLink is unchanged by password reset
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

# ğŸ—ï¸ FLOOR 7: The Tools Explained

## Tool 1: pywhisker

pywhisker automates the Shadow Credentials attack. Here's what it does internally:

```
pywhisker internally does:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Connects to DC as wwhite (the attacker account)
  2. Looks up jpinkman's AD object
  3. Generates a new RSA key pair (public + private)
  4. Creates an X.509 certificate from the public key
  5. Adds the public key to jpinkman's msDS-KeyCredentialLink
  6. Saves the certificate + private key as a .pfx file
  7. Tells you the .pfx filename and password
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

```bash
pywhisker \
  --dc-ip 10.129.234.174 \    # Where is the DC?
  -d INLANEFREIGHT.LOCAL \    # What domain?
  -u wwhite \                 # Authenticate as who?
  -p 'package5shores_topher1' \ # With what password?
  --target jpinkman \         # Modify whose account?
  --action add                # What to do? (add a key)
  
  
pywhisker --dc-ip 10.129.234.174 -d INLANEFREIGHT.LOCAL -u wwhite -p 'package5shores_topher1' -t jpinkman -a add
```

## Tool 2: gettgtpkinit.py (from PKINITtools)

This tool takes your `.pfx` file and performs the PKINIT exchange with the KDC to get a TGT:

```
gettgtpkinit.py internally does:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. Loads the certificate and private key from .pfx
  2. Sends a Kerberos AS-REQ to the DC
     BUT instead of password hash, uses the certificate
  3. Signs the request with the private key
  4. KDC checks: is this key in jpinkman's 
     msDS-KeyCredentialLink? YES!
  5. KDC issues TGT for jpinkman
  6. TGT saved to a .ccache file
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

```bash
python3 gettgtpkinit.py \
  -cert-pfx yourfile.pfx \     # The certificate+key file
  -pfx-pass 'password' \       # Password protecting the pfx
  -dc-ip 10.129.234.174 \      # DC to get ticket from
  INLANEFREIGHT.LOCAL/jpinkman \ # Domain/username
  /tmp/jpinkman.ccache           # Where to save the TGT
```

## What is a .ccache file?

On Linux, Kerberos tickets are stored in `.ccache` files (Credential Cache). It's the Linux equivalent of Windows' in-memory ticket store.

```bash
export KRB5CCNAME=/tmp/jpinkman.ccache
# This tells ALL Kerberos-aware tools on Linux:
# "Use THIS file when you need a Kerberos ticket"

klist
# This shows you what tickets are currently cached:
# Who they're for, when they expire, etc.
```

## Tool 3: Evil-WinRM

WinRM = Windows Remote Management. It's a protocol that lets you get a **PowerShell shell** on a remote Windows machine (like SSH for Windows).

Evil-WinRM is a hacker-friendly WinRM client. It can use Kerberos tickets for authentication:

```bash
evil-winrm \
  -i dc01.inlanefreight.local \  # Connect to this host
  -r INLANEFREIGHT.LOCAL          # Use Kerberos realm
  # It automatically uses whatever is in $KRB5CCNAME
```

Once connected, you get a PowerShell prompt on the target machine as jpinkman.

---

# ğŸ—ï¸ FLOOR 8: The ESC8 Attack (For the Second Flag)

## What is ESC8?

ESC8 is one of the misconfigurations in AD CS discovered by researchers (the others are ESC1 through ESC7 and beyond). It specifically targets the **web enrollment interface** of AD CS.

```
AD CS Web Enrollment:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - AD CS has a website at: http://CA_IP/CertSrv
  - Users/computers can visit this to request certs
  - It uses NTLM authentication to identify who's asking
  - Problem: It's over HTTP (no TLS), so relay attacks work
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## The Printer Bug (SpoolSample)

To do NTLM relay, you need a victim to authenticate TO YOU. You can wait... or you can **force** them.

The **Printer Bug** exploits the Windows Print Spooler service. There's a function in the print spooler that says "notify this host when something changes on this printer." Attackers abuse this to make any Windows machine with Print Spooler running authenticate to an arbitrary IP.

```
PRINTER BUG:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Attackerâ†’ DC01: "Hey, subscribe DC01's print spooler 
                 to send notifications to 10.10.16.12"

DC01: "OK, I'll connect to 10.10.16.12 to notify them"

DC01$ â†’ 10.10.16.12: *attempts NTLM authentication*

Attacker: "Got DC01$'s NTLM auth! Relay it to CA01!"
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

## Tool: impacket-ntlmrelayx

This is the relay tool. It:

1. Listens for inbound NTLM authentication on port 445 (SMB)
2. When a victim connects, relays their auth to a target
3. In `--adcs` mode: relays to the certificate web enrollment page
4. Gets a certificate issued in the victim's name

```bash
impacket-ntlmrelayx \
  -t http://10.129.234.172/certsrv/certfnsh.asp \ # Relay TO here
  --adcs \              # Tell it to do AD CS enrollment
  -smb2support \        # Accept SMB2 connections
  --template KerberosAuthentication  # Request this cert template
```

The `KerberosAuthentication` template is specifically used by Domain Controllers. When issued to DC01$, this certificate allows DC01$ to do Kerberos authentication.

## Tool: impacket-secretsdump (DCSync)

Once you have a TGT as DC01$, you can do **DCSync**.

DCSync abuses how Domain Controllers replicate data. Real DCs sync their databases with each other constantly. An attacker acting as DC01$ can ask another DC:

```
"Hey DC, I'm DC01 and I need to sync.
 Give me the password hashes for Administrator."

DC: "Sure, here they are: [NTLM hash]"
```

```bash
impacket-secretsdump \
  -k \                  # Use Kerberos (our TGT)
  -no-pass \            # No password needed
  -dc-ip 10.129.234.174 \
  -just-dc-user Administrator \  # Only get Admin hash
  'INLANEFREIGHT.LOCAL/DC01$'@DC01.INLANEFREIGHT.LOCAL
```

---

# ğŸ—ï¸ FLOOR 9: BloodHound & Attack Path Discovery

## What is BloodHound?

BloodHound is a tool that maps all the relationships in Active Directory and finds attack paths. It uses graph theory â€” nodes are AD objects (users, groups, computers), edges are relationships/permissions between them.

```
BloodHound might show you:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  wwhite â”€â”€[AddKeyCredentialLink]â”€â”€> jpinkman
  
  This means: wwhite has write permission to 
  jpinkman's msDS-KeyCredentialLink attribute
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

The **AddKeyCredentialLink** edge is exactly what enables the Shadow Credentials attack.

---

# ğŸ—ï¸ FLOOR 10: PassTheCert (Edge Case)

## When PKINIT Doesn't Work

Sometimes you have a valid certificate but PKINIT fails because:

- The KDC doesn't support the right Extended Key Usage (EKU) in the cert
- The cert template wasn't meant for client authentication

In this case, **PassTheCert** lets you use the certificate directly against **LDAPS** (LDAP over SSL â€” the protocol used to read/write AD objects).

```
PassTheCert can:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - Change a user's password
  - Add yourself to a group
  - Grant DCSync rights to your account
  - All using certificate auth to LDAP
  - No Kerberos needed at all
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

This is an alternative path when the Kerberos route is blocked.

---

# ğŸ—ºï¸ THE COMPLETE PICTURE: All Attacks Together

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ATTACK PATHS MAP                         â”‚
â”‚                                                             â”‚
â”‚  YOU HAVE: wwhite / package5shores_topher1                  â”‚
â”‚                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PATH 1: jpinkman's flag â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                             â”‚
â”‚  wwhite has AddKeyCredentialLink on jpinkman                â”‚
â”‚         â†“                                                   â”‚
â”‚  [pywhisker] Add our public key to jpinkman's               â”‚
â”‚  msDS-KeyCredentialLink â†’ get .pfx file                     â”‚
â”‚         â†“                                                   â”‚
â”‚  [gettgtpkinit.py] Use .pfx â†’ get TGT as jpinkman          â”‚
â”‚         â†“                                                   â”‚
â”‚  [export KRB5CCNAME] Set TGT in environment                 â”‚
â”‚         â†“                                                   â”‚
â”‚  [evil-winrm] Connect to DC01 as jpinkman via WinRM         â”‚
â”‚         â†“                                                   â”‚
â”‚  Read C:\Users\jpinkman\Desktop\flag.txt                    â”‚
â”‚                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â• PATH 2: Administrator's flag â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                             â”‚
â”‚  [ntlmrelayx] Start relay listener â†’ target CA01/CertSrv   â”‚
â”‚         â†“                                                   â”‚
â”‚  [printerbug.py] Force DC01$ to auth to us                  â”‚
â”‚         â†“                                                   â”‚
â”‚  ntlmrelayx relays â†’ CA01 issues cert for DC01$            â”‚
â”‚         â†“                                                   â”‚
â”‚  [gettgtpkinit.py] Use DC01$.pfx â†’ TGT as DC01$            â”‚
â”‚         â†“                                                   â”‚
â”‚  [secretsdump] DCSync â†’ get Administrator NTLM hash         â”‚
â”‚         â†“                                                   â”‚
â”‚  Use hash to access Administrator's desktop                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ“š Summary: Key Concepts Cheat Sheet

|Concept|What It Is|Why It Matters|
|---|---|---|
|Kerberos|AD auth protocol|TGT = master pass for domain access|
|TGT|Kerberos master ticket|Steal/forge this = impersonate anyone|
|PKINIT|Certificate-based Kerberos|.pfx file â†’ get TGT without password|
|X.509 / .pfx|Certificate file format|Contains cert + private key = identity|
|AD CS|Microsoft's certificate authority|Issues certs; misconfigured = game over|
|msDS-KeyCredentialLink|AD attribute|Write access = Shadow Credentials attack|
|Shadow Credentials|Add your key to victim's trusted list|Persists through password resets|
|NTLM Relay|Man-in-middle NTLM auth|Force victim to auth to you â†’ relay to target|
|ESC8|AD CS web enrollment relay|Relay DC auth â†’ get DC cert â†’ DCSync|
|DCSync|Fake DC replication|Dump all password hashes in the domain|
|.ccache|Linux Kerberos ticket store|Used by tools like evil-winrm|
|PassTheCert|Cert-based LDAP auth|Alternative when PKINIT fails|

---

Now that you understand **all the concepts**, do you want to move on to the actual lab challenge? Tell me when you're ready and we'll do Flag 1 (jpinkman) step by step with full explanations of what's happening at each step!