# IMAP & POP3

---

## Overview

- **IMAP** (Internet Message Access Protocol) - allows accessing and managing emails directly on the mail server
- **POP3** (Post Office Protocol) - downloads emails from the server to the local client

![[attachments/Pasted image 20251222090927.png]]

## Default Ports

| Protocol | Port |
|----------|------|
| IMAP | 143 |
| IMAPS (SSL) | 993 |
| POP3 | 110 |
| POP3S (SSL) | 995 |

## IMAP Commands

| **Command**                     | **Description**                                                                                               |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| `1 LOGIN username password`     | User's login.                                                                                                 |
| `1 LIST "" *`                   | Lists all directories.                                                                                        |
| `1 CREATE "INBOX"`              | Creates a mailbox with a specified name.                                                                      |
| `1 DELETE "INBOX"`              | Deletes a mailbox.                                                                                            |
| `1 RENAME "ToRead" "Important"` | Renames a mailbox.                                                                                            |
| `1 LSUB "" *`                   | Returns a subset of names from the set of names that the User has declared as being `active` or `subscribed`. |
| `1 SELECT INBOX`                | Selects a mailbox so that messages in the mailbox can be accessed.                                            |
| `1 UNSELECT INBOX`              | Exits the selected mailbox.                                                                                   |
| `1 FETCH <ID> all`              | Retrieves data associated with a message in the mailbox.                                                      |
| `1 CLOSE`                       | Removes all messages with the `Deleted` flag set.                                                             |
| `1 LOGOUT`                      | Closes the connection with the IMAP server.                                                                   |

## POP3 Commands

| **Command**     | **Description**                                             |
| --------------- | ----------------------------------------------------------- |
| `USER username` | Identifies the user.                                        |
| `PASS password` | Authentication of the user using its password.              |
| `STAT`          | Requests the number of saved emails from the server.        |
| `LIST`          | Requests from the server the number and size of all emails. |
| `RETR id`       | Requests the server to deliver the requested email by ID.   |
| `DELE id`       | Requests the server to delete the requested email by ID.    |
| `CAPA`          | Requests the server to display the server capabilities.     |
| `RSET`          | Requests the server to reset the transmitted information.   |
| `QUIT`          | Closes the connection with the POP3 server.                 |

## Footprinting the service

| Port       | **Description** |
| ---------- | --------------- |
| `110, 995` | POP3            |
| `143, 993` | IMAP            |
 - 993 and 995 use TLS/ SSL to encrypt the client server communication.
- If we successfully figure out the access credentials for one of the employees, an attacker could log in to the mail server and read or even send the individual messages.

```bash
curl -k 'imaps://<ip-address>' --user user:password
```

- `To interact with IMAP or POP3 server over SSL`, we can use openssl, as well as ncat. The commands for this are given below : 

```bash
openssl s_client -connect <ip-address>:pop3s
```


## OpenSSL - TLS Encrypted Interaction IMAP

```bash
openssl s_client -connect <ip-address>:imaps
```


## IMAP Enumeration

```bash
openssl s_client -connect 10.129.42.195:993 -crlf -quiet
```

### Enumerating the mailbox.
```bash
$ openssl s_client -connect 10.129.42.195:993 -crlf -quiet
Cant use SSL_get_servername

Certificate info:
C = UK, ST = London, L = London, O = InlaneFreight Ltd, OU = DevOps Department, CN = dev.inlanefreight.htb, emailAddress = cto.dev@dev.inlanefreight.htb

IMAP server:
* OK [CAPABILITY IMAP4rev1 SASL-IR LOGIN-REFERRALS ID ENABLE IDLE LITERAL+ AUTH=PLAIN] HTB{roncfbw7iszerd7shni7jr2343zhrj}  #Flag

Login:
a1 LOGIN robin robin
a1 OK Logged in

Mailbox enumeration:
a5 LIST "" "*"
* LIST (\Noselect \HasChildren) "." DEV
* LIST (\Noselect \HasChildren) "." DEV.DEPARTMENT
* LIST (\HasNoChildren) "." DEV.DEPARTMENT.INT
* LIST (\HasNoChildren) "." INBOX
a5 OK List completed

Selecting and checking mailboxes:
a9 SELECT DEV.DEPARTMENT.INT
* FLAGS (\Answered \Flagged \Deleted \Seen \Draft)
* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted
* 1 EXISTS
* 0 RECENT
* OK [UIDVALIDITY 1636414279] UIDs valid
* OK [UIDNEXT 2] Predicted next UID
a9 OK [READ-WRITE] Select completed

Fetching the message with the flag:
a10 FETCH 1 RFC822
* 1 FETCH (RFC822 {167}
Subject: Flag
To: Robin <robin@inlanefreight.htb>
From: CTO <devadmin@inlanefreight.htb>  #found the admin email.
Date: Wed, 03 Nov 2021 16:13:27 +0200

HTB{983uzn8jmfgpd8jmof8c34n7zio} # Final flag.
)
a10 OK Fetch completed

```

---

See also: [[8. DNS]], [[9. SMTP]]