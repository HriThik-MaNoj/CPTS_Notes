# SMB

Server Message Block - regulates access to files and entire directories and other network resources such as printers, routers, or interfaces released for the network.

- Particularly used in Windows
- In IP networks, SMB uses TCP protocol to establish a connection

---

## Samba

Alternative implementation of SMB server for Unix-based operating systems.

- Port: `TCP 445`
- `Workgroup`: Group name that identifies an arbitrary collection of computers and their resources on an SMB network
- There can be multiple workgroups on the network at any given time

## SMBclient

### Connecting to the Share

```bash
smbclient -N -L //10.129.14.128

smbclient //10.129.184.50/sambashare -N

smbclient //10.129.237.95/Users -U 'alex%lol123!mD'
```

### Download Files from SMB

```bash
smb: \> get prep-prod.txt 
```

## Footprinting SMB

```bash
sudo nmap <ip-address> -sV -sC -p139,445
```

In certain scenarios nmap scan doesn't provide much info, so we need to interact with the SMB and send specific requests for the information.

## RPCclient

```bash
rpcclient -U "" <ip-address>
```

| Query | Description |
|-------|-------------|
| `srvinfo` | Server information |
| `enumdomains` | Enumerate all domains that are deployed in the network |
| `querydominfo` | Provides domain, server, and user information of deployed domains |
| `netshareenumall` | Enumerates all available shares |
| `netsharegetinfo <share>` | Provides information about a specific share |
| `enumdomusers` | Enumerates all domain users |
| `queryuser <RID>` | Provides information about a specific user |

### Brute Forcing User RIDs

```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

## Other Enumeration Tools

The information obtained using `rpcclient` can also be obtained using other tools:

### SMBMap

```bash
smbmap -H <ip-address>
smbmap -H 10.129.2.85 -u 'alex' -p 'lol123!mD'
```

### CrackMapExec

```bash
crackmapexec smb 10.129.14.128 --shares -u '' -p ''
```

### Enum4linux-ng

```bash
./enum4linux-ng.py 10.129.14.128 -A
```

---

See also: [[5. FTP]], [[7. NFS]]
